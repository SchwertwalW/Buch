// Lokale Datenoper<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Buchverwaltung</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="description" content="Pers√∂nliche Buchverwaltung mit Cloud-Synchronisation">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1laW5lIEJ1Y2h2ZXJ3YWx0dW5nIiwKICAic2hvcnRfbmFtZSI6ICJCdWNodmVyd2FsdHVuZyIsCiAgImRlc2NyaXB0aW9uIjogIlBlcnPDtm5saWNoZSBCdWNodmVyd2FsdHVuZyBtaXQgQ2xvdWQtU3luY2hyb25pc2F0aW9uIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMzQ5OGRiIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00zUnZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJK1BHUmxabk0rUEhOMGVXeGxQaTV1WVhZdGJHbHVhejVtYVd4c09tNXZibVU3YzNSeWIydGxPbU5oY25KcFlXZDBiM0E3YzNSeWIydGxMWGRwWkhSb09qSTdabWxzYkMxeWRXeGxPbVYyWlc1dlpHUTdQQzl6ZEhsc1pUNGdMaTVqYjI1MGFXeDBleTV1WVhZdFpuSmhiV1YrTGk1dVlYWXRiR2x1YXlvMlhHRTJKVzVpYzNBN1ppWnVZbk53T3o4dlpHVm1jejQ4YzJOeWFYQjBQaVpzZERzeVpESmpOeVU2UTJoaGNuUXViSFJOWVhOemFXNWxLQ1JrWVhSaEtUdGpaRzkzYm14dllXUW9KR3g0YkVoMGJXd3NKSFJsZUhRc0pHWnBiR1Z1WVcxbEtUdDhQQzl6WTNKcGNIUStQQzl6ZG1jKyIsICJzaXplcyI6ICIyNHgyNCIsICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiIH0sCiAgICB7ICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M00zUnZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJK1BHUmxabk0rUEhOMGVXeGxQaTV1WVhZdGJHbHVhejVtYVd4c09tNXZibVU3YzNSeWIydGxPbU5oY25KcFlXZDBiM0E3YzNSeWIydGxMWGRwWkhSb09qSTdabWxzYkMxeWRXeGxPbVYyWlc1dlpHUTdQQzl6ZEhsc1pUNGdMaTVqYjI1MGFXeDBleTV1WVhZdFpuSmhiV1YrTGk1dVlYWXRiR2x1YXlvMlhHRTJKVzVpYzNBN1ppWnVZbk53T3o4dlpHVm1jejQ4YzJOeWFYQjBQaVpzZERzeVpESmpOeVU2UTJoaGNuUXViSFJOWVhOemFXNWxLQ1JrWVhSaEtUdGpaRzkzYm14dllXUW9KR3g0YkVoMGJXd3NKSFJsZUhRc0pHWnBiR1Z1WVcxbEtUdDhQQzl6WTNKcGNIUStQQzl6ZG1jKyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIgfQogIF0sCiAgImxhbmciOiAiZGUiCn0=">
    
    <!-- Mobile optimiert -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Buchverwaltung">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: rgba(255, 255, 255, 0.95);
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #bdc3c7;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size: 16px;
            --border-radius: 8px;
        }

        /* Dark Theme */
        .theme-dark {
            --primary-color: #5dade2;
            --secondary-color: #34495e;
            --accent-color: #e67e22;
            --success-color: #58d68d;
            --warning-color: #f7dc6f;
            --background-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-background: rgba(52, 73, 94, 0.95);
            --text-color: #ecf0f1;
            --text-secondary: #bdc3c7;
            --border-color: #5d6d7e;
        }

        /* Ocean Theme */
        .theme-ocean {
            --primary-color: #17a2b8;
            --secondary-color: #004085;
            --accent-color: #fd7e14;
            --success-color: #20c997;
            --warning-color: #ffc107;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: rgba(255, 255, 255, 0.95);
            --text-color: #004085;
            --text-secondary: #6c757d;
            --border-color: #bee5eb;
        }

        /* Forest Theme */
        .theme-forest {
            --primary-color: #28a745;
            --secondary-color: #155724;
            --accent-color: #dc3545;
            --success-color: #20c997;
            --warning-color: #ffc107;
            --background-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --card-background: rgba(255, 255, 255, 0.95);
            --text-color: #155724;
            --text-secondary: #6c757d;
            --border-color: #c3e6cb;
        }

        /* Sunset Theme */
        .theme-sunset {
            --primary-color: #fd7e14;
            --secondary-color: #721c24;
            --accent-color: #e83e8c;
            --success-color: #20c997;
            --warning-color: #ffc107;
            --background-gradient: linear-gradient(135deg, #ff9a56 0%, #ff6b95 100%);
            --card-background: rgba(255, 255, 255, 0.95);
            --text-color: #721c24;
            --text-secondary: #6c757d;
            --border-color: #f8d7da;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size);
            background: var(--background-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--card-background);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            background: var(--secondary-color);
            border-bottom: 3px solid var(--primary-color);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: var(--font-size);
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: var(--primary-color);
        }

        .tab.active {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .tab-content {
            padding: 30px;
            min-height: 600px;
            background: var(--card-background);
            color: var(--text-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: var(--font-size);
            font-family: var(--font-family);
            transition: border-color 0.3s ease;
            background: var(--card-background);
            color: var(--text-color);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .image-upload {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: border-color 0.3s ease;
            background: var(--card-background);
        }

        .image-upload:hover {
            border-color: var(--primary-color);
        }

        .image-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px auto;
            border-radius: var(--border-radius);
            display: none;
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-picker:hover {
            transform: scale(1.1);
        }

        .color-picker input[type="color"] {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size);
            font-family: var(--font-family);
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 20px;
            background: rgba(52, 152, 219, 0.1);
            color: var(--text-color);
            font-family: var(--font-family);
        }

        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .book-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--primary-color);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .book-card.custom-color {
            border-left-width: 8px;
        }

        .book-image {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--border-radius);
            float: right;
            margin-left: 15px;
            margin-bottom: 10px;
        }

        .book-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .book-series {
            color: #9b59b6;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .book-author {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 10px;
        }

        .book-group {
            background: #e8f8f5;
            color: #16a085;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 10px;
        }

        .book-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
            font-size: 14px;
            clear: both;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #27ae60);
            transition: width 0.3s ease;
        }

        .rating {
            display: flex;
            margin: 10px 0;
        }

        .star {
            color: var(--warning-color);
            font-size: 18px;
            margin-right: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: var(--font-size);
        }

        .chart-container {
            background: var(--card-background);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .genre-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: var(--border-radius);
        }

        .genre-name {
            width: 120px;
            font-weight: bold;
            color: var(--text-color);
        }

        .genre-progress {
            flex: 1;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }

        .genre-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            transition: width 0.5s ease;
        }

        .genre-count {
            font-weight: bold;
            color: var(--text-color);
        }

        .hidden {
            display: none;
        }

        .filter-section {
            background: rgba(248, 249, 250, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .export-section {
            background: rgba(232, 248, 245, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .group-section {
            background: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .group-title {
            font-size: 1.5em;
            color: var(--text-color);
            font-weight: bold;
        }

        .group-count {
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .series-books {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .series-book {
            background: rgba(248, 249, 250, 0.5);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            backdrop-filter: blur(5px);
        }

        /* Theme Selector */
        .theme-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .theme-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            border-color: white;
            transform: scale(1.2);
        }

        .theme-default { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .theme-dark { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); }
        .theme-ocean { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .theme-forest { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .theme-sunset { background: linear-gradient(135deg, #ff9a56 0%, #ff6b95 100%); }gap: 10px;
            flex-wrap: wrap;
        }

        .group-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .group-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: bold;
        }

        .group-count {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .series-books {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .series-book {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .book-list {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #2ecc71;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Meine Buchverwaltung</h1>
            <p>Verwalten Sie Ihre pers√∂nliche Bibliothek mit Cloud-Synchronisation</p>
            <div style="margin-top: 15px;">
                <div id="connection-status" style="font-size: 16px; font-weight: bold;">üî¥ Lokal gespeichert (nicht verbunden)</div>
                <div style="margin-top: 10px;">
                    <button id="google-connect-btn" class="btn" onclick="handleAuthClick()" disabled>
                        üîó Mit Google Drive verbinden
                    </button>
                    <button id="google-disconnect-btn" class="btn btn-danger" onclick="handleSignoutClick()" style="display: none;">
                        üîå Von Google Drive trennen
                    </button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('add')">Buch hinzuf√ºgen</button>
            <button class="tab" onclick="showTab('list')">B√ºcherliste</button>
            <button class="tab" onclick="showTab('series')">Serien</button>
            <button class="tab" onclick="showTab('groups')">Gruppierungen</button>
            <button class="tab" onclick="showTab('genres')">Genre-Verwaltung</button>
            <button class="tab" onclick="showTab('stats')">Statistiken</button>
            <button class="tab" onclick="showTab('settings')">Einstellungen</button>
            <button class="tab" onclick="showTab('export')">Export</button>
        </div>

        <!-- Buch hinzuf√ºgen Tab -->
        <div id="add-tab" class="tab-content">
            <h2>Neues Buch hinzuf√ºgen</h2>
            <form id="book-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bookColor">Buchfarbe (optional):</label>
                        <div class="color-picker-group">
                            <div class="color-picker">
                                <input type="color" id="bookColor" value="#3498db">
                            </div>
                            <span>W√§hlen Sie eine individuelle Farbe f√ºr dieses Buch</span>
                            <button type="button" class="btn" onclick="resetBookColor()" style="margin: 0; padding: 5px 10px; font-size: 12px;">Zur√ºcksetzen</button>
                        </div>
                    </div>
                        <label for="author">Autor:</label>
                        <input type="text" id="author" required>
                    </div>
                    <div class="form-group">
                        <label for="title">Buchtitel:</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="series">Serie (optional):</label>
                        <input type="text" id="series" list="seriesList" placeholder="Name der Buchserie">
                        <datalist id="seriesList"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="seriesNumber">Band Nr. in Serie:</label>
                        <input type="number" id="seriesNumber" min="1" placeholder="z.B. 1, 2, 3...">
                    </div>
                    <div class="form-group">
                        <label for="genre">Genre:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="genre" required style="flex: 1;">
                                <option value="">W√§hlen Sie ein Genre</option>
                            </select>
                            <button type="button" class="btn" onclick="showGenreModal()" style="margin: 0; padding: 8px 15px;">+ Neues Genre</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="group">Gruppierung (optional):</label>
                        <input type="text" id="group" list="groupsList" placeholder="z.B. Favoriten, Zu lesen, Geschenke">
                        <datalist id="groupsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="progress">Fortschritt (%):</label>
                        <input type="number" id="progress" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label for="rating">Bewertung (1-10):</label>
                        <input type="number" id="rating" min="1" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="dateFinished">Datum fertiggelesen:</label>
                        <input type="date" id="dateFinished">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bookImage">Buchcover (optional):</label>
                    <div class="image-upload">
                        <input type="file" id="bookImage" accept="image/*">
                        <p>üì∑ Klicken Sie hier oder ziehen Sie ein Bild hierher</p>
                        <img id="imagePreview" class="image-preview" alt="Vorschau">
                    </div>
                </div>

                <div class="form-group">
                    <label for="comments">Kommentare:</label>
                    <textarea id="comments" rows="3" placeholder="Ihre Gedanken zum Buch..."></textarea>
                </div>
                
                <button type="submit" class="btn">Buch hinzuf√ºgen</button>
                <button type="button" class="btn" onclick="resetForm()">Formular zur√ºcksetzen</button>
            </form>
        </div>

        <!-- B√ºcherliste Tab -->
        <div id="list-tab" class="tab-content hidden">
            <h2>Meine B√ºcher</h2>
            
            <div class="filter-section">
                <h3>Filter & Suche</h3>
                <div class="filter-row">
                    <input type="text" id="search" class="search-box" placeholder="Suchen nach Titel, Autor, Serie, Genre...">
                </div>
                <div class="filter-row">
                    <select id="filterGenre">
                        <option value="">Alle Genres</option>
                    </select>
                    <select id="filterSeries">
                        <option value="">Alle Serien</option>
                    </select>
                    <select id="filterGroup">
                        <option value="">Alle Gruppierungen</option>
                    </select>
                    <select id="filterStatus">
                        <option value="">Alle Status</option>
                        <option value="completed">Fertig gelesen</option>
                        <option value="reading">Gerade lesend</option>
                        <option value="not-started">Noch nicht begonnen</option>
                    </select>
                    <select id="sortBy">
                        <option value="title">Nach Titel</option>
                        <option value="author">Nach Autor</option>
                        <option value="series">Nach Serie</option>
                        <option value="rating">Nach Bewertung</option>
                        <option value="dateFinished">Nach Datum</option>
                        <option value="progress">Nach Fortschritt</option>
                    </select>
                </div>
            </div>

            <div id="book-list" class="book-list"></div>
        </div>

        <!-- Serien Tab -->
        <div id="series-tab" class="tab-content hidden">
            <h2>Buchserien</h2>
            <div id="series-list"></div>
        </div>

        <!-- Genre-Verwaltung Tab -->
        <div id="genres-tab" class="tab-content hidden">
            <h2>Genre-Verwaltung</h2>
            
            <div style="margin-bottom: 30px;">
                <button class="btn btn-success" onclick="showGenreModal()">üìù Neues Genre hinzuf√ºgen</button>
                <button class="btn" onclick="resetToDefaultGenres()">üîÑ Standard-Genres wiederherstellen</button>
            </div>
            
            <div class="filter-section">
                <h3>Verwendete Genres</h3>
                <div id="genre-usage-info" style="margin-bottom: 20px; color: #7f8c8d;">
                    Hier sehen Sie alle verf√ºgbaren Genres und wie oft sie verwendet werden.
                </div>
            </div>

            <div id="genres-list" class="book-list"></div>
        </div>
        <div id="groups-tab" class="tab-content hidden">
            <h2>Buchgruppierungen</h2>
            <div>
                <button class="btn btn-success" onclick="showGroupModal()">Neue Gruppierung erstellen</button>
            </div>
            <div id="groups-list"></div>
        </div>

        <!-- Statistiken Tab -->
        <div id="stats-tab" class="tab-content hidden">
            <h2>Statistiken</h2>
            
            <div class="export-section">
                <h3>Statistiken exportieren</h3>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportStats('pdf')">üìÑ Als PDF</button>
                    <button class="btn btn-success" onclick="exportStats('excel')">üìä Als Excel</button>
                    <button class="btn btn-success" onclick="exportStats('word')">üìù Als Word</button>
                    <button class="btn btn-success" onclick="exportStats('txt')">üìã Als Text</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalBooks">0</div>
                    <div class="stat-label">B√ºcher insgesamt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedBooks">0</div>
                    <div class="stat-label">Fertig gelesen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSeries">0</div>
                    <div class="stat-label">Buchserien</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageRating">0</div>
                    <div class="stat-label">Durchschnittsbewertung</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="readingProgress">0%</div>
                    <div class="stat-label">Gesamtfortschritt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGroups">0</div>
                    <div class="stat-label">Gruppierungen</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>B√ºcher nach Genre</h3>
                <div id="genreChart"></div>
            </div>

            <div class="chart-container">
                <h3>Bewertungsverteilung</h3>
                <div id="ratingChart"></div>
            </div>

            <div class="chart-container">
                <h3>Serien-Statistiken</h3>
                <div id="seriesChart"></div>
            </div>
        </div>

        <!-- Einstellungen Tab -->
        <div id="settings-tab" class="tab-content hidden">
            <h2>‚öôÔ∏è Einstellungen</h2>
            
            <div class="group-section">
                <h3>üì± Mobile & Zugriff</h3>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>üåê √úberall verf√ºgbar</h4>
                    <p>Diese Anwendung funktioniert auf allen Ger√§ten mit Internet:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>üì± <strong>Smartphones</strong> (Android, iPhone)</li>
                        <li>üíª <strong>Laptops & Computer</strong> (Windows, Mac, Linux)</li>
                        <li>üìü <strong>Tablets</strong> (iPad, Android-Tablets)</li>
                        <li>üåê <strong>Alle Browser</strong> (Chrome, Firefox, Safari, Edge)</li>
                    </ul>
                </div>
                
                <div style="background: #e8f8f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>üì± Als App installieren</h4>
                    <p>Installieren Sie die Buchverwaltung als App auf Ihrem Ger√§t:</p>
                    <button class="btn btn-success" onclick="triggerInstall()">üì± App installieren</button>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-top: 10px;">
                        Nach der Installation k√∂nnen Sie die App wie jede andere App √∂ffnen und auch offline nutzen.
                    </p>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <h4>‚òÅÔ∏è Cloud-Synchronisation</h4>
                    <p>Mit Google Drive bleiben Ihre Daten √ºberall synchron:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>‚úÖ Automatische Synchronisation zwischen allen Ger√§ten</li>
                        <li>‚úÖ Offline-Zugriff (Daten werden lokal gespeichert)</li>
                        <li>‚úÖ Sicheres Backup in der Cloud</li>
                        <li>‚úÖ Keine Datenverluste</li>
                    </ul>
                </div>
            </div>
                <h3>üé® Design & Erscheinungsbild</h3>
                
                <div class="form-group">
                    <label>Farbthema:</label>
                    <div class="theme-selector">
                        <div class="theme-option theme-default active" onclick="changeTheme('default')" title="Standard"></div>
                        <div class="theme-option theme-dark" onclick="changeTheme('dark')" title="Dunkel"></div>
                        <div class="theme-option theme-ocean" onclick="changeTheme('ocean')" title="Ozean"></div>
                        <div class="theme-option theme-forest" onclick="changeTheme('forest')" title="Wald"></div>
                        <div class="theme-option theme-sunset" onclick="changeTheme('sunset')" title="Sonnenuntergang"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customFont">Schriftart:</label>
                    <select id="customFont" onchange="changeFont(this.value)">
                        <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Standard (Segoe UI)</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                        <option value="Impact, sans-serif">Impact</option>
                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Lucida Console', monospace">Lucida Console</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fontSize">Schriftgr√∂√üe:</label>
                    <input type="range" id="fontSize" min="12" max="24" value="16" onchange="changeFontSize(this.value)">
                    <span id="fontSizeValue">16px</span>
                </div>

                <div class="form-group">
                    <label>Benutzerdefinierte Farben:</label>
                    <div class="color-picker-group">
                        <div class="color-picker">
                            <input type="color" id="customPrimary" value="#3498db" onchange="changeCustomColor('primary', this.value)">
                        </div>
                        <span>Prim√§rfarbe</span>
                    </div>
                    <div class="color-picker-group">
                        <div class="color-picker">
                            <input type="color" id="customSecondary" value="#2c3e50" onchange="changeCustomColor('secondary', this.value)">
                        </div>
                        <span>Sekund√§rfarbe</span>
                    </div>
                    <div class="color-picker-group">
                        <div class="color-picker">
                            <input type="color" id="customAccent" value="#e74c3c" onchange="changeCustomColor('accent', this.value)">
                        </div>
                        <span>Akzentfarbe</span>
                    </div>
                    <button class="btn" onclick="resetCustomColors()">üîÑ Farben zur√ºcksetzen</button>
                </div>
            </div>

            <div class="group-section">
                <h3>üìö Genre-Farben verwalten</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Weisen Sie Ihren Genres individuelle Farben zu. Diese werden in der B√ºcherliste als Randfarbe angezeigt.
                </p>
                <div id="genre-color-settings"></div>
            </div>

            <div class="group-section">
                <h3>üíæ Daten & Backup</h3>
                <button class="btn btn-success" onclick="exportSettings()">‚öôÔ∏è Einstellungen exportieren</button>
                <button class="btn" onclick="document.getElementById('importSettings').click()">üì• Einstellungen importieren</button>
                <input type="file" id="importSettings" accept=".json" style="display: none;" onchange="importSettings(event)">
                <button class="btn btn-danger" onclick="resetAllSettings()">üóëÔ∏è Alle Einstellungen zur√ºcksetzen</button>
            </div>

            <div class="group-section">
                <h3>‚ÑπÔ∏è √úber die Anwendung</h3>
                <p><strong>Buchverwaltung Pro</strong> - Version 2.0</p>
                <p>Eine umfassende L√∂sung f√ºr die Verwaltung Ihrer pers√∂nlichen Bibliothek mit Cloud-Synchronisation, erweiterten Statistiken und vollst√§ndig anpassbarem Design.</p>
                <p style="margin-top: 15px;">
                    <strong>Features:</strong> Google Drive Integration, Export-Funktionen, Genre-Verwaltung, Serien-Tracking, Gruppierungen, Statistiken, Anpassbare Themes
                </p>
            </div>
        </div>
        <div id="export-tab" class="tab-content hidden">
            <h2>Daten exportieren</h2>
            
            <div class="export-section">
                <h3>B√ºcherliste exportieren</h3>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportBooks('pdf')">üìÑ Liste als PDF</button>
                    <button class="btn btn-success" onclick="exportBooks('excel')">üìä Liste als Excel</button>
                    <button class="btn btn-success" onclick="exportBooks('word')">üìù Liste als Word</button>
                    <button class="btn btn-success" onclick="exportBooks('txt')">üìã Liste als Text</button>
                </div>
            </div>

            <div class="export-section">
                <h3>Gefilterte Liste exportieren</h3>
                <p>Wechseln Sie zur B√ºcherliste, wenden Sie gew√ºnschte Filter an und kehren Sie dann hierher zur√ºck.</p>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportFilteredBooks('pdf')">üìÑ Gefilterte Liste als PDF</button>
                    <button class="btn btn-success" onclick="exportFilteredBooks('excel')">üìä Gefilterte Liste als Excel</button>
                    <button class="btn btn-success" onclick="exportFilteredBooks('word')">üìù Gefilterte Liste als Word</button>
                    <button class="btn btn-success" onclick="exportFilteredBooks('txt')">üìã Gefilterte Liste als Text</button>
                </div>
            </div>

            <div class="export-section">
                <h3>Backup erstellen</h3>
                <p>Erstellen Sie eine vollst√§ndige Sicherung Ihrer Daten.</p>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="createBackup()">üíæ Vollst√§ndiges Backup</button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">üì• Backup importieren</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Genre-Modal -->
    <div id="genreModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGenreModal()">&times;</span>
            <h3 id="genreModalTitle">Neues Genre hinzuf√ºgen</h3>
            <div class="form-group">
                <label for="genreName">Genre-Name:</label>
                <input type="text" id="genreName" placeholder="z.B. Science Fantasy, Urban Fantasy">
            </div>
            <div class="form-group">
                <label for="genreDescription">Beschreibung (optional):</label>
                <textarea id="genreDescription" rows="3" placeholder="Beschreibung des Genres..."></textarea>
            </div>
            <button class="btn btn-success" onclick="saveGenre()">Genre speichern</button>
            <button class="btn" onclick="closeGenreModal()">Abbrechen</button>
        </div>
    </div>

    <!-- Buch-Details Modal -->
    <div id="bookDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeBookDetailsModal()">&times;</span>
            <div id="bookDetailsContent"></div>
        </div>
    </div>
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGroupModal()">&times;</span>
            <h3>Neue Gruppierung erstellen</h3>
            <div class="form-group">
                <label for="groupName">Gruppierungsname:</label>
                <input type="text" id="groupName" placeholder="z.B. Favoriten, Zu lesen, Geschenke">
            </div>
            <div class="form-group">
                <label for="groupDescription">Beschreibung (optional):</label>
                <textarea id="groupDescription" rows="3" placeholder="Beschreibung der Gruppierung..."></textarea>
            </div>
            <button class="btn btn-success" onclick="createGroup()">Gruppierung erstellen</button>
        </div>
    </div>

    <!-- Google APIs laden -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // Service Worker f√ºr Offline-Funktionalit√§t registrieren
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'buchverwaltung-v1';
                    const urlsToCache = [
                        '/',
                        'https://apis.google.com/js/api.js',
                        'https://accounts.google.com/gsi/client'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker erfolgreich registriert:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker Registrierung fehlgeschlagen:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                color: white;
                padding: 15px;
                text-align: center;
                z-index: 1001;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            installBanner.innerHTML = `
                <div>üì± Diese App kann auf Ihrem Ger√§t installiert werden!</div>
                <button onclick="installApp()" style="background: white; color: var(--primary-color); border: none; padding: 8px 16px; border-radius: 4px; margin: 0 10px; cursor: pointer;">Installieren</button>
                <button onclick="dismissInstall()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Sp√§ter</button>
            `;
            installBanner.id = 'install-banner';
            document.body.prepend(installBanner);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('App erfolgreich installiert! üì±');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            const banner = document.getElementById('install-banner');
            if (banner) banner.remove();
        }
        const CLIENT_ID = 'IHR_CLIENT_ID_HIER_EINF√úGEN'; // TODO: Ersetzen Sie dies mit Ihrer Client ID
        const API_KEY = 'IHR_API_KEY_HIER_EINF√úGEN'; // TODO: Ersetzen Sie dies mit Ihrem API Key
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapi;
        let google;
        let tokenClient;
        let isGapiLoaded = false;
        let isGisLoaded = false;
        let isGoogleDriveConnected = false;
        let accessToken = null;

        // Datenbank - erweitert um Google Drive Synchronisation
        let books = [];
        let groups = [];
        let customGenres = JSON.parse(localStorage.getItem('customGenres')) || [];
        let genreColors = JSON.parse(localStorage.getItem('genreColors')) || {};
        let appSettings = JSON.parse(localStorage.getItem('appSettings')) || {
            theme: 'default',
            font: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            fontSize: '16px',
            customColors: {}
        };
        let editingIndex = -1;
        let editingGenreIndex = -1;
        let currentFilteredBooks = [];
        let isOnlineMode = false;

        // Standard-Genres - erweiterte Liste mit vielen Beispielen
        const defaultGenres = [
            // Belletristik/Fiction
            'Roman', 'Kurzgeschichten', 'Novelle', 'Epos',
            
            // Fantasy & Sci-Fi
            'Fantasy', 'High Fantasy', 'Urban Fantasy', 'Dark Fantasy', 
            'Science Fiction', 'Hard Science Fiction', 'Space Opera', 'Cyberpunk',
            'Steampunk', 'Dystopie', 'Utopie', 'Zeitreise', 'Alternate History',
            'LitRPG', 'GameLit', 'Progression Fantasy',
            
            // Thriller & Spannung
            'Thriller', 'Krimi', 'Cozy Mystery', 'Hard-boiled', 'Noir',
            'Psychothriller', 'Techno-Thriller', 'Spionage-Thriller',
            'Horror', 'Gothic Horror', 'Supernatural Horror', 'Zombie',
            'Mystery', 'Detective', 'Whodunit',
            
            // Romance & Drama
            'Liebesroman', 'Contemporary Romance', 'Historical Romance',
            'Paranormal Romance', 'Romantic Suspense', 'Erotik',
            'Familiensaga', 'Generationenroman', 'Drama',
            
            // Historisch & Kulturell
            'Historisch', 'Historischer Roman', 'Mittelalter', 'Antike',
            'Zeitgeschichte', 'Biografischer Roman', 'Kriegsroman',
            'Western', 'Samurai', 'Piraten',
            
            // Abenteuer & Action
            'Abenteuer', 'Action', 'Survival', 'Expedition',
            'Milit√§r', 'Post-Apokalypse', 'Katastrophe',
            
            // Spezielle Genres
            'Coming-of-Age', 'Bildungsroman', 'Campus Novel',
            'Chick-Lit', 'New Adult', 'Young Adult', 'Jugendliteratur',
            'Kinderbuch', 'M√§rchen', 'Fabel', 'Sage',
            
            // Sachbuch/Non-Fiction
            'Biographie', 'Autobiographie', 'Memoiren',
            'Sachbuch', 'Wissenschaft', 'Geschichte', 'Politik',
            'Philosophie', 'Religion', 'Psychologie', 'Medizin',
            'Ratgeber', 'Selbsthilfe', 'Coaching', 'Business',
            'Reisebericht', 'Kochbuch', 'Kunst', 'Musik',
            'Sport', 'Natur', 'Technik', 'Computer',
            'Gesundheit', 'Fitness', 'Ern√§hrung',
            
            // Weitere Kategorien
            'Humor', 'Satire', 'Parodie', 'Comedy',
            'Experimental', 'Avantgarde', 'Postmodern',
            'Graphic Novel', 'Comic', 'Manga', 'Light Novel',
            'Poetry', 'Lyrik', 'Gedichte', 'Essays',
            'Tagebuch', 'Brief', 'Dokumentation',
            'True Crime', 'Gerichtsmedizin', 'Forensik',
            'Alternate Reality', 'Virtual Reality', 'AI Fiction',
            'Biopunk', 'Climate Fiction', 'Solarpunk',
            'Weird Fiction', 'New Weird', 'Bizarro',
            'Andere'
        ];

        // Alle verf√ºgbaren Genres
        function getAllGenres() {
            return [...defaultGenres, ...customGenres.map(g => g.name)].sort();
        }

        // Google APIs laden
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            isGapiLoaded = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // wird sp√§ter definiert
            });
            isGisLoaded = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (isGapiLoaded && isGisLoaded) {
                const connectBtn = document.getElementById('google-connect-btn');
                if (connectBtn) {
                    connectBtn.disabled = false;
                }
                // Versuche automatisch lokale Daten zu laden
                loadLocalData();
            }
        }

        // Google Drive Verbindung
        async function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                isGoogleDriveConnected = true;
                isOnlineMode = true;
                updateConnectionStatus();
                showNotification('Erfolgreich mit Google Drive verbunden!');
                await loadDataFromGoogleDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                isGoogleDriveConnected = false;
                isOnlineMode = false;
                accessToken = null;
                updateConnectionStatus();
                showNotification('Von Google Drive getrennt. Wechsel zu lokalem Modus.');
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            const connectBtn = document.getElementById('google-connect-btn');
            const disconnectBtn = document.getElementById('google-disconnect-btn');
            
            if (statusElement) {
                if (isGoogleDriveConnected) {
                    statusElement.innerHTML = 'üü¢ Mit Google Drive verbunden';
                    statusElement.style.color = '#2ecc71';
                    if (connectBtn) connectBtn.style.display = 'none';
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                } else {
                    statusElement.innerHTML = 'üî¥ Lokal gespeichert (nicht verbunden)';
                    statusElement.style.color = '#e74c3c';
                    if (connectBtn) connectBtn.style.display = 'inline-block';
                    if (disconnectBtn) disconnectBtn.style.display = 'none';
                }
            }
        }

        // Google Drive Datenoperationen
        async function saveDataToGoogleDrive() {
            if (!isGoogleDriveConnected) return;

            try {
                const data = {
                    books: books,
                    groups: groups,
                    lastModified: new Date().toISOString()
                };

                const fileContent = JSON.stringify(data, null, 2);
                const fileName = 'buchverwaltung_daten.json';

                // Pr√ºfe ob Datei bereits existiert
                const existingFile = await findFileByName(fileName);
                
                if (existingFile) {
                    // Datei aktualisieren
                    await updateFileInGoogleDrive(existingFile.id, fileContent);
                } else {
                    // Neue Datei erstellen
                    await createFileInGoogleDrive(fileName, fileContent);
                }

                showNotification('Daten erfolgreich in Google Drive gespeichert!');
            } catch (error) {
                console.error('Fehler beim Speichern in Google Drive:', error);
                showNotification('Fehler beim Speichern in Google Drive. Lokale Kopie gespeichert.', 'error');
                // Fallback: lokal speichern
                saveDataLocally();
            }
        }

        async function loadDataFromGoogleDrive() {
            if (!isGoogleDriveConnected) return;

            try {
                const fileName = 'buchverwaltung_daten.json';
                const file = await findFileByName(fileName);
                
                if (file) {
                    const fileContent = await downloadFileFromGoogleDrive(file.id);
                    const data = JSON.parse(fileContent);
                    
                    books = data.books || [];
                    groups = data.groups || [];
                    
                    updateDataLists();
                    displayBooks();
                    showNotification('Daten erfolgreich von Google Drive geladen!');
                } else {
                    // Keine Datei gefunden, verwende lokale Daten
                    loadLocalData();
                    showNotification('Keine Cloud-Daten gefunden. Lokale Daten werden verwendet.');
                }
            } catch (error) {
                console.error('Fehler beim Laden von Google Drive:', error);
                showNotification('Fehler beim Laden von Google Drive. Lokale Daten werden verwendet.', 'error');
                loadLocalData();
            }
        }

        async function findFileByName(fileName) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and parents in 'root'`,
                    fields: 'files(id, name)',
                });
                
                const files = response.result.files;
                return files.length > 0 ? files[0] : null;
            } catch (error) {
                console.error('Fehler beim Suchen der Datei:', error);
                return null;
            }
        }

        async function createFileInGoogleDrive(fileName, content) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const metadata = {
                'name': fileName,
                'parents': ['root']
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                content +
                close_delim;

            const request = gapi.client.request({
                'path': 'https://www.googleapis.com/upload/drive/v3/files',
                'method': 'POST',
                'params': {'uploadType': 'multipart'},
                'headers': {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                'body': multipartRequestBody
            });

            return request;
        }

        async function updateFileInGoogleDrive(fileId, content) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                content +
                close_delim;

            const request = gapi.client.request({
                'path': 'https://www.googleapis.com/upload/drive/v3/files/' + fileId,
                'method': 'PATCH',
                'params': {'uploadType': 'media'},
                'headers': {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                'body': multipartRequestBody
            });

            return request;
        }

        async function downloadFileFromGoogleDrive(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                console.error('Fehler beim Herunterladen der Datei:', error);
                throw error;
            }
        }

        // Lokale Datenoperationen (Fallback)
        function saveDataLocally() {
            localStorage.setItem('books', JSON.stringify(books));
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        function loadLocalData() {
            books = JSON.parse(localStorage.getItem('books')) || [];
            groups = JSON.parse(localStorage.getItem('groups')) || [];
            customGenres = JSON.parse(localStorage.getItem('customGenres')) || [];
            genreColors = JSON.parse(localStorage.getItem('genreColors')) || {};
            appSettings = JSON.parse(localStorage.getItem('appSettings')) || {
                theme: 'default',
                font: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                fontSize: '16px',
                customColors: {}
            };
            updateDataLists();
            updateConnectionStatus();
            applyCurrentSettings();
            initializeGenres(); // Genres neu laden
        }

        // Erweiterte Speicherfunktion
        async function saveData() {
            if (isOnlineMode && isGoogleDriveConnected) {
                await saveDataToGoogleDrive();
            } else {
                saveDataLocally();
            }
        }

        // Tab-Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            if (tabName === 'list') {
                displayBooks();
                updateFilters();
            } else if (tabName === 'stats') {
                updateStatistics();
            } else if (tabName === 'series') {
                displaySeries();
            } else if (tabName === 'groups') {
                displayGroups();
            } else if (tabName === 'genres') {
                displayGenres();
            } else if (tabName === 'settings') {
                displaySettings();
            }
        }

        // Bild-Upload Handler
        document.getElementById('bookImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Buch hinzuf√ºgen/bearbeiten
        document.getElementById('book-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const imageFile = document.getElementById('bookImage').files[0];
            let imageData = null;
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveBook(imageData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveBook(editingIndex !== -1 ? books[editingIndex].image : null);
            }
        });

        function saveBook(imageData) {
            const author = document.getElementById('author').value.trim();
            const title = document.getElementById('title').value.trim();
            
            // Nur Autor und Titel sind Pflichtfelder
            if (!author) {
                alert('Bitte geben Sie einen Autor ein.');
                return;
            }
            
            if (!title) {
                alert('Bitte geben Sie einen Buchtitel ein.');
                return;
            }
            
            const book = {
                author: author,
                title: title,
                series: document.getElementById('series').value.trim() || null,
                seriesNumber: parseInt(document.getElementById('seriesNumber').value) || null,
                genre: document.getElementById('genre').value || 'Andere',
                group: document.getElementById('group').value.trim() || null,
                progress: parseInt(document.getElementById('progress').value) || 0,
                rating: parseFloat(document.getElementById('rating').value) || 0,
                dateFinished: document.getElementById('dateFinished').value || null,
                comments: document.getElementById('comments').value.trim() || null,
                image: imageData,
                color: document.getElementById('bookColor').value !== '#3498db' ? document.getElementById('bookColor').value : null,
                dateAdded: editingIndex === -1 ? new Date().toISOString() : books[editingIndex].dateAdded
            };

            if (editingIndex === -1) {
                books.push(book);
                showNotification('Buch erfolgreich hinzugef√ºgt!');
            } else {
                books[editingIndex] = book;
                showNotification('Buch erfolgreich aktualisiert!');
                editingIndex = -1;
            }

            await saveData(); // Google Drive oder lokal speichern
            resetForm();
            updateDataLists();
        }

        // Formular zur√ºcksetzen
        function resetForm() {
            document.getElementById('book-form').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('bookColor').value = '#3498db';
            editingIndex = -1;
            document.querySelector('#add-tab h2').textContent = 'Neues Buch hinzuf√ºgen';
        }

        function resetBookColor() {
            document.getElementById('bookColor').value = '#3498db';
        }

        // Datenlisten aktualisieren
        function updateDataLists() {
            updateSeriesList();
            updateGroupsList();
            updateGenreSelect();
            updateFilters();
        }

        function updateSeriesList() {
            const seriesList = document.getElementById('seriesList');
            const series = [...new Set(books.filter(book => book.series).map(book => book.series))];
            seriesList.innerHTML = '';
            series.forEach(serie => {
                const option = document.createElement('option');
                option.value = serie;
                seriesList.appendChild(option);
            });
        }

        function updateGroupsList() {
            const groupsList = document.getElementById('groupsList');
            const bookGroups = [...new Set(books.filter(book => book.group).map(book => book.group))];
            groupsList.innerHTML = '';
            bookGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                groupsList.appendChild(option);
            });
        }

        function updateGenreSelect() {
            const genreSelect = document.getElementById('genre');
            if (!genreSelect) return;
            
            const allGenres = getAllGenres();
            const currentValue = genreSelect.value;
            
            genreSelect.innerHTML = '<option value="">W√§hlen Sie ein Genre</option>';
            allGenres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });
            
            // Aktuellen Wert wiederherstellen
            if (currentValue && allGenres.includes(currentValue)) {
                genreSelect.value = currentValue;
            }
        }

        // Genre-Liste beim ersten Laden initialisieren
        function initializeGenres() {
            updateGenreSelect();
        }

        // B√ºcher anzeigen
        function displayBooks() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const genreFilter = document.getElementById('filterGenre').value;
            const seriesFilter = document.getElementById('filterSeries').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;

            let filteredBooks = books.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(searchTerm) ||
                                    book.author.toLowerCase().includes(searchTerm) ||
                                    book.genre.toLowerCase().includes(searchTerm) ||
                                    (book.series && book.series.toLowerCase().includes(searchTerm));
                
                const matchesGenre = !genreFilter || book.genre === genreFilter;
                const matchesSeries = !seriesFilter || book.series === seriesFilter;
                const matchesGroup = !groupFilter || book.group === groupFilter;
                
                let matchesStatus = true;
                if (statusFilter === 'completed') matchesStatus = book.progress === 100;
                else if (statusFilter === 'reading') matchesStatus = book.progress > 0 && book.progress < 100;
                else if (statusFilter === 'not-started') matchesStatus = book.progress === 0;

                return matchesSearch && matchesGenre && matchesSeries && matchesGroup && matchesStatus;
            });

            // Sortierung
            filteredBooks.sort((a, b) => {
                switch(sortBy) {
                    case 'title': return a.title.localeCompare(b.title);
                    case 'author': return a.author.localeCompare(b.author);
                    case 'series': return (a.series || '').localeCompare(b.series || '');
                    case 'rating': return b.rating - a.rating;
                    case 'dateFinished': return new Date(b.dateFinished || 0) - new Date(a.dateFinished || 0);
                    case 'progress': return b.progress - a.progress;
                    default: return 0;
                }
            });

            currentFilteredBooks = filteredBooks;

            const bookList = document.getElementById('book-list');
            bookList.innerHTML = '';

            filteredBooks.forEach((book, index) => {
                const originalIndex = books.indexOf(book);
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                
                // Individuelle Buchfarbe oder Genre-Farbe anwenden
                const cardColor = book.color || genreColors[book.genre] || 'var(--primary-color)';
                if (book.color || genreColors[book.genre]) {
                    bookCard.classList.add('custom-color');
                    bookCard.style.borderLeftColor = cardColor;
                }
                
                const stars = generateStars(book.rating);
                const progressColor = book.progress === 100 ? '#2ecc71' : book.progress > 0 ? '#f39c12' : '#95a5a6';
                
                bookCard.innerHTML = `
                    ${book.image ? `<img src="${book.image}" alt="Buchcover" class="book-image">` : ''}
                    <div class="book-title">${book.title}</div>
                    ${book.series ? `<div class="book-series">üìö ${book.series}${book.seriesNumber ? ` (Band ${book.seriesNumber})` : ''}</div>` : ''}
                    <div class="book-author">von ${book.author}</div>
                    ${book.group ? `<div class="book-group">üè∑Ô∏è ${book.group}</div>` : ''}
                    
                    <div class="book-info">
                        <div class="info-item">
                            <span>Genre:</span>
                            <span>${book.genre || 'Nicht angegeben'}</span>
                        </div>
                        ${book.rating > 0 ? `
                            <div class="info-item">
                                <span>Bewertung:</span>
                                <div class="rating">${stars} (${book.rating}/10)</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${book.progress}%; background: ${progressColor}"></div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <strong>${book.progress}% gelesen</strong>
                    </div>
                    
                    ${book.dateFinished ? `<p><strong>Fertig gelesen am:</strong> ${formatDate(book.dateFinished)}</p>` : ''}
                    ${book.comments ? `<p><strong>Kommentare:</strong> ${book.comments}</p>` : ''}
                    
                    <div style="margin-top: 15px; clear: both;">
                        <button class="btn" onclick="editBook(${originalIndex})">‚úèÔ∏è Bearbeiten</button>
                        <button class="btn" onclick="showBookDetails(${originalIndex})">üëÅÔ∏è Details</button>
                        <button class="btn btn-danger" onclick="deleteBook(${originalIndex})">üóëÔ∏è L√∂schen</button>
                    </div>
                `;
                
                bookList.appendChild(bookCard);
            });
        }

        // Serien anzeigen
        function displaySeries() {
            const seriesData = {};
            
            books.forEach(book => {
                if (book.series) {
                    if (!seriesData[book.series]) {
                        seriesData[book.series] = [];
                    }
                    seriesData[book.series].push(book);
                }
            });

            const seriesList = document.getElementById('series-list');
            seriesList.innerHTML = '';

            Object.entries(seriesData).forEach(([seriesName, seriesBooks]) => {
                // Nach Bandnummer sortieren
                seriesBooks.sort((a, b) => (a.seriesNumber || 0) - (b.seriesNumber || 0));
                
                const seriesSection = document.createElement('div');
                seriesSection.className = 'group-section';
                
                const completedInSeries = seriesBooks.filter(book => book.progress === 100).length;
                const avgRating = seriesBooks.reduce((sum, book) => sum + book.rating, 0) / seriesBooks.length;
                
                seriesSection.innerHTML = `
                    <div class="group-header">
                        <div class="group-title">üìö ${seriesName}</div>
                        <div class="group-count">${seriesBooks.length} B√ºcher</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Fortschritt:</strong> ${completedInSeries}/${seriesBooks.length} gelesen 
                        | <strong>√ò Bewertung:</strong> ${avgRating.toFixed(1)}/10
                    </div>
                    <div class="series-books">
                        ${seriesBooks.map(book => `
                            <div class="series-book">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    ${book.image ? `<img src="${book.image}" alt="Cover" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px; margin-right: 10px;">` : ''}
                                    <div>
                                        <div style="font-weight: bold;">${book.seriesNumber ? `Band ${book.seriesNumber}: ` : ''}${book.title}</div>
                                        <div style="color: #7f8c8d; font-size: 0.9em;">${book.author}</div>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 0.9em;">
                                        ${generateStars(book.rating)} ${book.rating}/10
                                    </div>
                                    <div style="font-size: 0.9em; color: ${book.progress === 100 ? '#2ecc71' : book.progress > 0 ? '#f39c12' : '#95a5a6'};">
                                        ${book.progress}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                seriesList.appendChild(seriesSection);
            });

            if (Object.keys(seriesData).length === 0) {
                seriesList.innerHTML = '<div class="group-section"><p>Keine Buchserien vorhanden. F√ºgen Sie B√ºcher mit Serieninformationen hinzu.</p></div>';
            }
        }

        // Genre-Verwaltung
        function displayGenres() {
            const genresList = document.getElementById('genres-list');
            const allGenres = getAllGenres();
            const genreUsage = {};
            
            // Z√§hle Verwendung jedes Genres
            books.forEach(book => {
                genreUsage[book.genre] = (genreUsage[book.genre] || 0) + 1;
            });

            genresList.innerHTML = '';

            allGenres.forEach(genre => {
                const usage = genreUsage[genre] || 0;
                const isCustom = customGenres.some(g => g.name === genre);
                const customGenreData = customGenres.find(g => g.name === genre);
                
                const genreCard = document.createElement('div');
                genreCard.className = 'book-card';
                genreCard.style.borderLeft = isCustom ? '5px solid #9b59b6' : '5px solid #3498db';
                
                genreCard.innerHTML = `
                    <div class="book-title">${genre}</div>
                    <div style="color: #7f8c8d; margin-bottom: 10px;">
                        ${isCustom ? 'üé® Benutzerdefiniert' : 'üìö Standard-Genre'}
                    </div>
                    ${customGenreData && customGenreData.description ? `<p style="margin-bottom: 15px; color: #2c3e50;">${customGenreData.description}</p>` : ''}
                    
                    <div class="book-info">
                        <div class="info-item">
                            <span>Verwendung:</span>
                            <span><strong>${usage} B√ºcher</strong></span>
                        </div>
                        <div class="info-item">
                            <span>Typ:</span>
                            <span>${isCustom ? 'Benutzerdefiniert' : 'Standard'}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        ${isCustom ? `
                            <button class="btn" onclick="editGenre('${genre}')">‚úèÔ∏è Bearbeiten</button>
                            <button class="btn btn-danger" onclick="deleteGenre('${genre}', ${usage})" ${usage > 0 ? 'title="Genre wird noch verwendet!"' : ''}>
                                üóëÔ∏è L√∂schen ${usage > 0 ? '(' + usage + ')' : ''}
                            </button>
                        ` : `
                            <span style="color: #7f8c8d; font-style: italic;">Standard-Genre (nicht l√∂schbar)</span>
                        `}
                        ${usage > 0 ? `<button class="btn" onclick="showBooksWithGenre('${genre}')">üìñ B√ºcher anzeigen</button>` : ''}
                    </div>
                `;
                
                genresList.appendChild(genreCard);
            });

            if (allGenres.length === 0) {
                genresList.innerHTML = '<div class="group-section"><p>Keine Genres vorhanden.</p></div>';
            }
        }

        function showGenreModal(genreName = null) {
            editingGenreIndex = -1;
            document.getElementById('genreModalTitle').textContent = 'Neues Genre hinzuf√ºgen';
            document.getElementById('genreName').value = '';
            document.getElementById('genreDescription').value = '';
            
            if (genreName) {
                const genre = customGenres.find(g => g.name === genreName);
                if (genre) {
                    editingGenreIndex = customGenres.indexOf(genre);
                    document.getElementById('genreModalTitle').textContent = 'Genre bearbeiten';
                    document.getElementById('genreName').value = genre.name;
                    document.getElementById('genreDescription').value = genre.description || '';
                }
            }
            
            document.getElementById('genreModal').style.display = 'block';
        }

        function closeGenreModal() {
            document.getElementById('genreModal').style.display = 'none';
        }

        async function saveGenre() {
            const name = document.getElementById('genreName').value.trim();
            const description = document.getElementById('genreDescription').value.trim();
            
            if (!name) {
                alert('Bitte geben Sie einen Genre-Namen ein.');
                return;
            }
            
            // Pr√ºfe ob Genre bereits existiert (au√üer beim Bearbeiten)
            const existingGenres = getAllGenres();
            const genreExists = existingGenres.some(g => g.toLowerCase() === name.toLowerCase());
            
            if (genreExists && editingGenreIndex === -1) {
                alert('Ein Genre mit diesem Namen existiert bereits.');
                return;
            }
            
            if (editingGenreIndex === -1) {
                // Neues Genre hinzuf√ºgen
                customGenres.push({ name, description });
                showNotification('Genre erfolgreich hinzugef√ºgt!');
            } else {
                // Bestehendes Genre bearbeiten
                const oldName = customGenres[editingGenreIndex].name;
                customGenres[editingGenreIndex] = { name, description };
                
                // Aktualisiere alle B√ºcher mit diesem Genre
                books.forEach(book => {
                    if (book.genre === oldName) {
                        book.genre = name;
                    }
                });
                
                showNotification('Genre erfolgreich aktualisiert!');
            }
            
            localStorage.setItem('customGenres', JSON.stringify(customGenres));
            await saveData();
            closeGenreModal();
            displayGenres();
            initializeGenres(); // Genre-Dropdown neu laden
            updateFilters();
        }

        function editGenre(genreName) {
            showGenreModal(genreName);
        }

        async function deleteGenre(genreName, usage) {
            if (usage > 0) {
                if (!confirm(`Das Genre "${genreName}" wird noch von ${usage} Buch/B√ºchern verwendet. Wenn Sie es l√∂schen, wird bei diesen B√ºchern das Genre zu "Andere" ge√§ndert. M√∂chten Sie fortfahren?`)) {
                    return;
                }
                
                // √Ñndere Genre aller betroffenen B√ºcher zu "Andere"
                books.forEach(book => {
                    if (book.genre === genreName) {
                        book.genre = 'Andere';
                    }
                });
            } else {
                if (!confirm(`Sind Sie sicher, dass Sie das Genre "${genreName}" l√∂schen m√∂chten?`)) {
                    return;
                }
            }
            
            customGenres = customGenres.filter(g => g.name !== genreName);
            localStorage.setItem('customGenres', JSON.stringify(customGenres));
            await saveData();
            displayGenres();
            updateGenreSelect();
            updateFilters();
            displayBooks(); // Aktualisiere die B√ºcherliste
            showNotification('Genre erfolgreich gel√∂scht!');
        }

        function resetToDefaultGenres() {
            if (confirm('M√∂chten Sie wirklich alle benutzerdefinierten Genres l√∂schen und nur die Standard-Genres behalten? B√ºcher mit benutzerdefinierten Genres werden auf "Andere" gesetzt.')) {
                // Aktualisiere alle B√ºcher mit benutzerdefinierten Genres
                const customGenreNames = customGenres.map(g => g.name);
                books.forEach(book => {
                    if (customGenreNames.includes(book.genre)) {
                        book.genre = 'Andere';
                    }
                });
                
                customGenres = [];
                localStorage.setItem('customGenres', JSON.stringify(customGenres));
                saveData();
                displayGenres();
                updateGenreSelect();
                updateFilters();
                displayBooks();
                showNotification('Standard-Genres wiederhergestellt!');
            }
        }

        function showBooksWithGenre(genreName) {
            // Wechsle zur B√ºcherliste und setze Filter
            showTab('list');
            document.getElementById('filterGenre').value = genreName;
            displayBooks();
            showNotification(`Zeige alle B√ºcher des Genres "${genreName}"`);
        }
        function displayGroups() {
            const groupsData = {};
            
            // Gruppierungen aus B√ºchern sammeln
            books.forEach(book => {
                if (book.group) {
                    if (!groupsData[book.group]) {
                        groupsData[book.group] = [];
                    }
                    groupsData[book.group].push(book);
                }
            });

            // Erstelle Gruppierungen hinzuf√ºgen
            groups.forEach(group => {
                if (!groupsData[group.name]) {
                    groupsData[group.name] = [];
                }
            });

            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';

            Object.entries(groupsData).forEach(([groupName, groupBooks]) => {
                const groupSection = document.createElement('div');
                groupSection.className = 'group-section';
                
                const groupInfo = groups.find(g => g.name === groupName);
                const completedInGroup = groupBooks.filter(book => book.progress === 100).length;
                const avgRating = groupBooks.length > 0 ? groupBooks.reduce((sum, book) => sum + book.rating, 0) / groupBooks.length : 0;
                
                groupSection.innerHTML = `
                    <div class="group-header">
                        <div class="group-title">üè∑Ô∏è ${groupName}</div>
                        <div class="group-count">${groupBooks.length} B√ºcher</div>
                    </div>
                    ${groupInfo && groupInfo.description ? `<p style="margin-bottom: 15px; color: #7f8c8d;">${groupInfo.description}</p>` : ''}
                    ${groupBooks.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <strong>Fortschritt:</strong> ${completedInGroup}/${groupBooks.length} gelesen 
                            | <strong>√ò Bewertung:</strong> ${avgRating.toFixed(1)}/10
                        </div>
                        <div class="series-books">
                            ${groupBooks.map(book => `
                                <div class="series-book">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        ${book.image ? `<img src="${book.image}" alt="Cover" style="width: 50px; height: 75px; object-fit: cover; border-radius: 4px; margin-right: 10px;">` : ''}
                                        <div>
                                            <div style="font-weight: bold;">${book.title}</div>
                                            <div style="color: #7f8c8d; font-size: 0.9em;">${book.author}</div>
                                            ${book.series ? `<div style="color: #9b59b6; font-size: 0.8em;">üìö ${book.series}</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 0.9em;">
                                            ${generateStars(book.rating)} ${book.rating}/10
                                        </div>
                                        <div style="font-size: 0.9em; color: ${book.progress === 100 ? '#2ecc71' : book.progress > 0 ? '#f39c12' : '#95a5a6'};">
                                            ${book.progress}%
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #7f8c8d;">Keine B√ºcher in dieser Gruppierung.</p>'}
                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="deleteGroup('${groupName}')">Gruppierung l√∂schen</button>
                    </div>
                `;
                
                groupsList.appendChild(groupSection);
            });

            if (Object.keys(groupsData).length === 0) {
                groupsList.innerHTML = '<div class="group-section"><p>Keine Gruppierungen vorhanden. Erstellen Sie eine neue Gruppierung.</p></div>';
            }
        }

        // Gruppierungs-Modal
        function showGroupModal() {
            document.getElementById('groupModal').style.display = 'block';
        }

        function closeGroupModal() {
            document.getElementById('groupModal').style.display = 'none';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            
            if (!name) {
                alert('Bitte geben Sie einen Gruppierungsnamen ein.');
                return;
            }
            
            if (groups.find(g => g.name === name)) {
                alert('Eine Gruppierung mit diesem Namen existiert bereits.');
                return;
            }
            
            groups.push({ name, description });
            saveData(); // Google Drive oder lokal speichern
            closeGroupModal();
            displayGroups();
            updateDataLists();
            showNotification('Gruppierung erfolgreich erstellt!');
        }

        function deleteGroup(groupName) {
            if (confirm(`Sind Sie sicher, dass Sie die Gruppierung "${groupName}" l√∂schen m√∂chten? B√ºcher in dieser Gruppierung bleiben erhalten.`)) {
                groups = groups.filter(g => g.name !== groupName);
                saveData(); // Google Drive oder lokal speichern
                displayGroups();
                showNotification('Gruppierung erfolgreich gel√∂scht!');
            }
        }

        // Export-Funktionen
        function exportStats(format) {
            const stats = generateStatsData();
            
            switch(format) {
                case 'pdf':
                    exportStatsToPDF(stats);
                    break;
                case 'excel':
                    exportStatsToExcel(stats);
                    break;
                case 'word':
                    exportStatsToWord(stats);
                    break;
                case 'txt':
                    exportStatsToTxt(stats);
                    break;
            }
        }

        function exportBooks(format) {
            exportBookList(books, format, 'Alle_B√ºcher');
        }

        function exportFilteredBooks(format) {
            exportBookList(currentFilteredBooks, format, 'Gefilterte_B√ºcher');
        }

        function exportBookList(bookList, format, filename) {
            switch(format) {
                case 'pdf':
                    exportBooksToPDF(bookList, filename);
                    break;
                case 'excel':
                    exportBooksToExcel(bookList, filename);
                    break;
                case 'word':
                    exportBooksToWord(bookList, filename);
                    break;
                case 'txt':
                    exportBooksToTxt(bookList, filename);
                    break;
            }
        }

        function generateStatsData() {
            const totalBooks = books.length;
            const completedBooks = books.filter(book => book.progress === 100).length;
            const avgRating = totalBooks > 0 ? (books.reduce((sum, book) => sum + book.rating, 0) / totalBooks).toFixed(1) : 0;
            const totalProgress = totalBooks > 0 ? Math.round(books.reduce((sum, book) => sum + book.progress, 0) / totalBooks) : 0;
            
            // Genre-Statistiken
            const genreStats = {};
            books.forEach(book => {
                genreStats[book.genre] = (genreStats[book.genre] || 0) + 1;
            });
            
            // Serien-Statistiken
            const seriesStats = {};
            books.forEach(book => {
                if (book.series) {
                    seriesStats[book.series] = (seriesStats[book.series] || 0) + 1;
                }
            });
            
            return {
                totalBooks,
                completedBooks,
                avgRating,
                totalProgress,
                totalSeries: Object.keys(seriesStats).length,
                totalGroups: groups.length,
                genreStats,
                seriesStats
            };
        }

        function exportStatsToPDF(stats) {
            const content = `
BUCHVERWALTUNG - STATISTIKEN
Erstellt am: ${new Date().toLocaleDateString('de-DE')}

=== ALLGEMEINE STATISTIKEN ===
B√ºcher insgesamt: ${stats.totalBooks}
Fertig gelesen: ${stats.completedBooks}
Buchserien: ${stats.totalSeries}
Gruppierungen: ${stats.totalGroups}
Durchschnittsbewertung: ${stats.avgRating}/10
Gesamtfortschritt: ${stats.totalProgress}%

=== GENRE-VERTEILUNG ===
${Object.entries(stats.genreStats).map(([genre, count]) => `${genre}: ${count} B√ºcher`).join('\n')}

=== SERIEN-√úBERSICHT ===
${Object.entries(stats.seriesStats).map(([series, count]) => `${series}: ${count} B√ºcher`).join('\n')}
            `;
            
            downloadTextFile(content, 'Buchstatistiken.txt');
            showNotification('Statistiken als Text-Datei exportiert!');
        }

        function exportStatsToExcel(stats) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Statistik,Wert\n";
            csvContent += `B√ºcher insgesamt,${stats.totalBooks}\n`;
            csvContent += `Fertig gelesen,${stats.completedBooks}\n`;
            csvContent += `Buchserien,${stats.totalSeries}\n`;
            csvContent += `Gruppierungen,${stats.totalGroups}\n`;
            csvContent += `Durchschnittsbewertung,${stats.avgRating}\n`;
            csvContent += `Gesamtfortschritt,${stats.totalProgress}%\n\n`;
            csvContent += "Genre,Anzahl\n";
            Object.entries(stats.genreStats).forEach(([genre, count]) => {
                csvContent += `${genre},${count}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Buchstatistiken.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Statistiken als Excel-Datei exportiert!');
        }

        function exportStatsToWord(stats) {
            const content = `
<html>
<head><meta charset="utf-8"></head>
<body>
<h1>Buchverwaltung - Statistiken</h1>
<p>Erstellt am: ${new Date().toLocaleDateString('de-DE')}</p>

<h2>Allgemeine Statistiken</h2>
<table border="1" style="border-collapse: collapse;">
<tr><td>B√ºcher insgesamt</td><td>${stats.totalBooks}</td></tr>
<tr><td>Fertig gelesen</td><td>${stats.completedBooks}</td></tr>
<tr><td>Buchserien</td><td>${stats.totalSeries}</td></tr>
<tr><td>Gruppierungen</td><td>${stats.totalGroups}</td></tr>
<tr><td>Durchschnittsbewertung</td><td>${stats.avgRating}/10</td></tr>
<tr><td>Gesamtfortschritt</td><td>${stats.totalProgress}%</td></tr>
</table>

<h2>Genre-Verteilung</h2>
<table border="1" style="border-collapse: collapse;">
<tr><th>Genre</th><th>Anzahl</th></tr>
${Object.entries(stats.genreStats).map(([genre, count]) => `<tr><td>${genre}</td><td>${count}</td></tr>`).join('')}
</table>
</body>
</html>
            `;
            
            const blob = new Blob([content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Buchstatistiken.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('Statistiken als Word-Datei exportiert!');
        }

        function exportStatsToTxt(stats) {
            exportStatsToPDF(stats); // Gleiche Implementierung
        }

        function exportBooksToPDF(bookList, filename) {
            const content = `
BUCHVERWALTUNG - B√úCHERLISTE
Erstellt am: ${new Date().toLocaleDateString('de-DE')}
Anzahl B√ºcher: ${bookList.length}

${'='.repeat(80)}

${bookList.map(book => `
TITEL: ${book.title}
AUTOR: ${book.author}
${book.series ? `SERIE: ${book.series}${book.seriesNumber ? ` (Band ${book.seriesNumber})` : ''}` : ''}
GENRE: ${book.genre}
${book.group ? `GRUPPIERUNG: ${book.group}` : ''}
BEWERTUNG: ${book.rating}/10
FORTSCHRITT: ${book.progress}%
${book.dateFinished ? `FERTIG GELESEN: ${formatDate(book.dateFinished)}` : ''}
${book.comments ? `KOMMENTARE: ${book.comments}` : ''}
${'-'.repeat(40)}
`).join('')}
            `;
            
            downloadTextFile(content, `${filename}.txt`);
            showNotification('B√ºcherliste als Text-Datei exportiert!');
        }

        function exportBooksToExcel(bookList, filename) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Titel,Autor,Serie,Band,Genre,Gruppierung,Bewertung,Fortschritt,Fertig gelesen,Kommentare\n";
            
            bookList.forEach(book => {
                const row = [
                    `"${book.title}"`,
                    `"${book.author}"`,
                    `"${book.series || ''}"`,
                    book.seriesNumber || '',
                    `"${book.genre}"`,
                    `"${book.group || ''}"`,
                    book.rating,
                    `${book.progress}%`,
                    book.dateFinished ? formatDate(book.dateFinished) : '',
                    `"${book.comments || ''}"`
                ].join(',');
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${filename}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('B√ºcherliste als Excel-Datei exportiert!');
        }

        function exportBooksToWord(bookList, filename) {
            const content = `
<html>
<head><meta charset="utf-8"><title>B√ºcherliste</title></head>
<body>
<h1>Buchverwaltung - B√ºcherliste</h1>
<p>Erstellt am: ${new Date().toLocaleDateString('de-DE')}</p>
<p>Anzahl B√ºcher: ${bookList.length}</p>

<table border="1" style="border-collapse: collapse; width: 100%;">
<tr style="background-color: #f0f0f0;">
<th>Titel</th><th>Autor</th><th>Serie</th><th>Genre</th><th>Bewertung</th><th>Fortschritt</th>
</tr>
${bookList.map(book => `
<tr>
<td>${book.title}</td>
<td>${book.author}</td>
<td>${book.series ? `${book.series}${book.seriesNumber ? ` (${book.seriesNumber})` : ''}` : ''}</td>
<td>${book.genre}</td>
<td>${book.rating}/10</td>
<td>${book.progress}%</td>
</tr>
`).join('')}
</table>
</body>
</html>
            `;
            
            const blob = new Blob([content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('B√ºcherliste als Word-Datei exportiert!');
        }

        function exportBooksToTxt(bookList, filename) {
            exportBooksToPDF(bookList, filename); // Gleiche Implementierung
        }

        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function createBackup() {
            const backupData = {
                books: books,
                groups: groups,
                exportDate: new Date().toISOString()
            };
            
            const jsonContent = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Buchverwaltung_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('Backup erfolgreich erstellt!');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (confirm('M√∂chten Sie wirklich alle aktuellen Daten durch das Backup ersetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                        books = backupData.books || [];
                        groups = backupData.groups || [];
                        
                        await saveData(); // Google Drive oder lokal speichern
                        
                        updateDataLists();
                        displayBooks();
                        showNotification('Backup erfolgreich importiert!');
                    }
                } catch (error) {
                    alert('Fehler beim Importieren der Datei. Stellen Sie sicher, dass es sich um eine g√ºltige Backup-Datei handelt.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Einstellungen-Funktionen
        function displaySettings() {
            displayGenreColorSettings();
            applyCurrentSettings();
        }

        function displayGenreColorSettings() {
            const container = document.getElementById('genre-color-settings');
            const allGenres = getAllGenres();
            
            container.innerHTML = '';
            
            allGenres.forEach(genre => {
                const genreDiv = document.createElement('div');
                genreDiv.style.cssText = 'display: flex; align-items: center; margin: 10px 0; padding: 10px; background: rgba(248, 249, 250, 0.5); border-radius: 8px;';
                
                const currentColor = genreColors[genre] || '#3498db';
                
                genreDiv.innerHTML = `
                    <div style="flex: 1; font-weight: bold;">${genre}</div>
                    <div class="color-picker" style="margin-right: 10px;">
                        <input type="color" value="${currentColor}" onchange="setGenreColor('${genre}', this.value)">
                    </div>
                    <button class="btn" onclick="removeGenreColor('${genre}')" style="margin: 0; padding: 5px 10px; font-size: 12px;">Zur√ºcksetzen</button>
                `;
                
                container.appendChild(genreDiv);
            });
        }

        function setGenreColor(genre, color) {
            genreColors[genre] = color;
            localStorage.setItem('genreColors', JSON.stringify(genreColors));
            displayBooks(); // B√ºcherliste aktualisieren
        }

        function removeGenreColor(genre) {
            delete genreColors[genre];
            localStorage.setItem('genreColors', JSON.stringify(genreColors));
            displayGenreColorSettings();
            displayBooks();
        }

        function changeTheme(themeName) {
            // Theme-Klassen entfernen
            document.body.classList.remove('theme-dark', 'theme-ocean', 'theme-forest', 'theme-sunset');
            
            // Neues Theme anwenden
            if (themeName !== 'default') {
                document.body.classList.add('theme-' + themeName);
            }
            
            // Theme-Auswahl aktualisieren
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector('.theme-' + themeName).classList.add('active');
            
            // Einstellungen speichern
            appSettings.theme = themeName;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function changeFont(fontFamily) {
            document.documentElement.style.setProperty('--font-family', fontFamily);
            appSettings.font = fontFamily;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function changeFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
            document.getElementById('fontSizeValue').textContent = size + 'px';
            appSettings.fontSize = size + 'px';
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function changeCustomColor(type, color) {
            const property = '--' + type + '-color';
            document.documentElement.style.setProperty(property, color);
            appSettings.customColors[type] = color;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function resetCustomColors() {
            document.getElementById('customPrimary').value = '#3498db';
            document.getElementById('customSecondary').value = '#2c3e50';
            document.getElementById('customAccent').value = '#e74c3c';
            
            document.documentElement.style.removeProperty('--primary-color');
            document.documentElement.style.removeProperty('--secondary-color');
            document.documentElement.style.removeProperty('--accent-color');
            
            appSettings.customColors = {};
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function applyCurrentSettings() {
            // Theme anwenden
            changeTheme(appSettings.theme);
            
            // Schrift anwenden
            document.getElementById('customFont').value = appSettings.font;
            changeFont(appSettings.font);
            
            // Schriftgr√∂√üe anwenden
            const fontSize = parseInt(appSettings.fontSize);
            document.getElementById('fontSize').value = fontSize;
            changeFontSize(fontSize);
            
            // Benutzerdefinierte Farben anwenden
            Object.entries(appSettings.customColors).forEach(([type, color]) => {
                document.getElementById('custom' + type.charAt(0).toUpperCase() + type.slice(1)).value = color;
                changeCustomColor(type, color);
            });
        }

        function exportSettings() {
            const settingsData = {
                appSettings: appSettings,
                genreColors: genreColors,
                customGenres: customGenres,
                exportDate: new Date().toISOString()
            };
            
            const jsonContent = JSON.stringify(settingsData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Buchverwaltung_Einstellungen_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showNotification('Einstellungen erfolgreich exportiert!');
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settingsData = JSON.parse(e.target.result);
                    
                    if (confirm('M√∂chten Sie wirklich alle aktuellen Einstellungen ersetzen?')) {
                        appSettings = settingsData.appSettings || appSettings;
                        genreColors = settingsData.genreColors || {};
                        customGenres = settingsData.customGenres || [];
                        
                        localStorage.setItem('appSettings', JSON.stringify(appSettings));
                        localStorage.setItem('genreColors', JSON.stringify(genreColors));
                        localStorage.setItem('customGenres', JSON.stringify(customGenres));
                        
                        applyCurrentSettings();
                        displaySettings();
                        updateGenreSelect();
                        showNotification('Einstellungen erfolgreich importiert!');
                    }
                } catch (error) {
                    alert('Fehler beim Importieren der Einstellungen.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function triggerInstall() {
            if (deferredPrompt) {
                installApp();
            } else {
                // Manuelle Installationsanweisungen
                const instructions = `
üì± APP INSTALLATION:

üî∏ CHROME/EDGE (Computer):
1. Klicken Sie auf ‚ãÆ (Men√º) ‚Üí "App installieren"
2. Oder: Adressleiste ‚Üí üì± Symbol ‚Üí "Installieren"

üî∏ CHROME (Android):
1. Men√º ‚Üí "Zum Startbildschirm hinzuf√ºgen"
2. Oder: "App installieren" Banner verwenden

üî∏ SAFARI (iPhone/iPad):
1. Teilen-Button ‚Üí "Zum Home-Bildschirm"
2. App-Name eingeben ‚Üí "Hinzuf√ºgen"

üî∏ FIREFOX:
1. Adressleiste ‚Üí üè† Symbol ‚Üí "Installieren"

Nach der Installation:
‚úÖ App funktioniert offline
‚úÖ Eigenes App-Icon auf dem Ger√§t
‚úÖ Vollbild-Modus ohne Browser-UI
‚úÖ Synchronisation mit Google Drive
                `;
                
                alert(instructions);
            }
        }
            if (confirm('M√∂chten Sie wirklich alle Einstellungen auf die Standardwerte zur√ºcksetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                localStorage.removeItem('appSettings');
                localStorage.removeItem('genreColors');
                localStorage.removeItem('customGenres');
                
                appSettings = {
                    theme: 'default',
                    font: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                    fontSize: '16px',
                    customColors: {}
                };
                genreColors = {};
                customGenres = [];
                
                location.reload(); // Seite neu laden
            }
        }
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<span class="star">‚òÖ</span>';
            }
            
            if (halfStar) {
                stars += '<span class="star">‚òÜ</span>';
            }
            
            return stars;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('de-DE');
        }

        function editBook(index) {
            const book = books[index];
            editingIndex = index;
            
            document.getElementById('author').value = book.author || '';
            document.getElementById('title').value = book.title || '';
            document.getElementById('series').value = book.series || '';
            document.getElementById('seriesNumber').value = book.seriesNumber || '';
            document.getElementById('genre').value = book.genre || '';
            document.getElementById('group').value = book.group || '';
            document.getElementById('progress').value = book.progress || 0;
            document.getElementById('rating').value = book.rating || '';
            document.getElementById('dateFinished').value = book.dateFinished || '';
            document.getElementById('comments').value = book.comments || '';
            document.getElementById('bookColor').value = book.color || '#3498db';
            
            // Bildvorschau setzen
            const preview = document.getElementById('imagePreview');
            if (book.image) {
                preview.src = book.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            
            document.querySelector('#add-tab h2').textContent = 'Buch bearbeiten';
            showTab('add');
        }

        // Verbesserte Buch-Details Anzeige
        function showBookDetails(index) {
            const book = books[index];
            const modal = document.getElementById('bookDetailsModal');
            const content = document.getElementById('bookDetailsContent');
            
            const stars = generateStars(book.rating);
            const progressColor = book.progress === 100 ? '#2ecc71' : book.progress > 0 ? '#f39c12' : '#95a5a6';
            
            content.innerHTML = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    ${book.image ? `
                        <div style="flex-shrink: 0;">
                            <img src="${book.image}" alt="Buchcover" style="width: 150px; height: 225px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        </div>
                    ` : ''}
                    <div style="flex: 1;">
                        <h2 style="color: #2c3e50; margin-bottom: 10px;">${book.title}</h2>
                        <p style="color: #7f8c8d; font-size: 1.2em; margin-bottom: 15px;"><strong>von ${book.author}</strong></p>
                        
                        ${book.series ? `
                            <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                <strong>üìö Serie:</strong> ${book.series}${book.seriesNumber ? ` (Band ${book.seriesNumber})` : ''}
                            </div>
                        ` : ''}
                        
                        ${book.group ? `
                            <div style="background: #e8f8f5; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                <strong>üè∑Ô∏è Gruppierung:</strong> ${book.group}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">Genre</div>
                                <div>${book.genre}</div>
                            </div>
                        ${book.rating > 0 ? `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">Bewertung</div>
                                <div>${stars} ${book.rating}/10</div>
                            </div>
                        ` : ''}
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">Fortschritt</div>
                                <div style="color: ${progressColor}; font-weight: bold;">${book.progress}%</div>
                            </div>
                            ${book.dateFinished ? `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <div style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">Fertig gelesen</div>
                                    <div>${formatDate(book.dateFinished)}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="width: 100%; background: #ecf0f1; border-radius: 10px; overflow: hidden; margin-bottom: 20px;">
                            <div style="width: ${book.progress}%; height: 20px; background: ${progressColor}; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
                
                ${book.comments ? `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">üí≠ Kommentare</h4>
                        <p style="line-height: 1.6;">${book.comments}</p>
                    </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="editBook(${index}); closeBookDetailsModal();">‚úèÔ∏è Buch bearbeiten</button>
                    <button class="btn btn-danger" onclick="if(confirm('Buch wirklich l√∂schen?')) { deleteBook(${index}); closeBookDetailsModal(); }">üóëÔ∏è Buch l√∂schen</button>
                    <button class="btn" onclick="closeBookDetailsModal()">Schlie√üen</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeBookDetailsModal() {
            document.getElementById('bookDetailsModal').style.display = 'none';
        }